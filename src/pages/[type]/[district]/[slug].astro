---
import Layout from "../../../layouts/Layout.astro";
import DataCard from "../../../components/DataCard";
import {
    DATA_TYPES,
    DISTRICTS,
    getApiUrl,
    getLocationName,
    slugify,
    getHighwayFromItem,
    getCounties,
    type DataTypeId,
    type AnyDataItem,
} from "../../../utils/caltrans";
import RelatedActions from "../../../components/RelatedActions";

export async function getStaticPaths() {
    const paths = [];

    // Iterate over all types and districts to fetch data and generate paths
    // Note: This might be slow for build time if there are many items.
    // We will do it sequentially to avoid rate limiting or overwhelming the build.

    for (const typeKey of Object.keys(DATA_TYPES)) {
        const type = DATA_TYPES[typeKey as DataTypeId];
        for (const districtId of type.districts) {
            try {
                const url = getApiUrl(typeKey as DataTypeId, districtId);
                const res = await fetch(url);
                if (!res.ok) continue;
                const json = await res.json();
                const data = json.data as AnyDataItem[];

                if (data && Array.isArray(data)) {
                    for (const item of data) {
                        try {
                            const name = getLocationName(item);
                            if (!name) continue;

                            const slug = slugify(name);
                            if (slug) {
                                paths.push({
                                    params: {
                                        type: typeKey,
                                        district: districtId,
                                        slug,
                                    },
                                    props: {
                                        item,
                                        type: typeKey,
                                        district: districtId,
                                        name,
                                    },
                                });
                            }
                        } catch (err) {
                            // Skip individual items that fail
                            continue;
                        }
                    }
                }
            } catch (e) {
                console.warn(
                    `Skipping ${typeKey} ${districtId}: ${(e as Error).message}`,
                );
            }
        }
    }
    return paths;
}

const { item, type, district, name } = Astro.props;
const dataType = DATA_TYPES[type as DataTypeId];
const districtInfo = DISTRICTS.find((d) => d.id === district);

// Data Context for SEO & Navigation
const highwayName = getHighwayFromItem(item);
const counties = getCounties(item);
const countyName = counties.length > 0 ? counties[0] : undefined;

const title = `${name} | ${dataType.name} ${highwayName ? `on ${highwayName}` : ""} | California Road Data`;

const relatedItems = {
    district: {
        id: district,
        name: districtInfo?.name || `District ${district}`,
        url: `/${type}/${district}`,
    },
    county: countyName
        ? {
              name: countyName,
              url: `/${type}/county/${encodeURIComponent(countyName)}`,
          }
        : undefined,
    highway: highwayName
        ? {
              name: highwayName,
              url: `/${type}/route/${encodeURIComponent(highwayName)}`,
          }
        : undefined,
};

const seoDescription = `Current ${dataType.name.toLowerCase()} status at ${name}${highwayName ? `, located on ${highwayName}` : ""}${countyName ? ` in ${countyName} County` : ""}. Real-time data from Caltrans District ${district}.`;
---

<Layout title={title}>
    <div class="mb-8">
        <div class="flex items-center gap-2 text-sm text-slate-400 mb-4">
            <a href="/" class="hover:text-brand-400 transition-colors">Home</a>
            <span>/</span>
            <a href={`/${type}`} class="hover:text-brand-400 transition-colors"
                >{dataType.name}</a
            >
            <span>/</span>
            <a
                href={`/${type}/${district}`}
                class="hover:text-brand-400 transition-colors"
                >{districtInfo?.name}</a
            >
            <span>/</span>
            <span class="text-slate-200 truncate max-w-[200px]">{name}</span>
        </div>

        <h1 class="text-3xl font-bold text-black mb-2 text-black">{name}</h1>
        <p class="text-black">{dataType.name} in {districtInfo?.name}</p>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="h-[400px]">
            <DataCard
                client:load
                type={type as DataTypeId}
                data={item as AnyDataItem}
            />
        </div>

        <div class="mt-12 prose prose-slate max-w-none">
            <h2 class="text-xl font-bold mb-3">About this Data Point</h2>
            <p>
                You are viewing {seoDescription}
            </p>
            <p>
                <strong>{name}</strong> is a specific data collection point maintained
                by Caltrans District {district} ({districtInfo?.name}). This
                page provides a focused view of the live feed, ensuring you have
                the latest information for this exact location.
            </p>
            <p>
                To see more updates nearby, use the buttons above to view all {
                    dataType.name.toLowerCase()
                } units
                {
                    highwayName ? (
                        <span>
                            {" "}
                            along <strong>{highwayName}</strong>
                        </span>
                    ) : (
                        ""
                    )
                }
                {
                    countyName ? (
                        <span>
                            {" "}
                            or within <strong>{countyName} County</strong>
                        </span>
                    ) : (
                        ""
                    )
                }.
            </p>
        </div>
    </div>
</Layout>
