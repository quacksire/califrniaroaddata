---
import Layout from "../../layouts/Layout.astro";
import Explorer from "../../components/Explorer";
import {
    DATA_TYPES,
    DISTRICTS,
    getApiUrl,
    type DataTypeId,
    type AnyDataItem,
} from "../../utils/caltrans";

export function getStaticPaths() {
    const paths = [];
    for (const typeKey of Object.keys(DATA_TYPES)) {
        const type = DATA_TYPES[typeKey as DataTypeId];
        for (const districtId of type.districts) {
            paths.push({
                params: { type: typeKey, district: districtId },
            });
        }
    }
    return paths;
}

const { type, district } = Astro.params;
const dataType = DATA_TYPES[type as DataTypeId];
const districtInfo = DISTRICTS.find((d) => d.id === district);

if (!dataType || !districtInfo) {
    return Astro.redirect("/404");
}

// Fetch data on the server
let initialData: AnyDataItem[] = [];
try {
    const url = getApiUrl(type as DataTypeId, district as string);
    const res = await fetch(url);
    if (res.ok) {
        const json = await res.json();
        if (json && Array.isArray(json.data)) {
            initialData = json.data;
        }
    }
} catch (e) {
    console.error(`Failed to fetch data for ${type} ${district}`, e);
}
---

<Layout title={`${dataType.name} - ${districtInfo.name}`}>
    <div class="mb-8">
        <div class="flex items-center gap-2 text-sm text-black mb-4">
            <a href="/" class="text-black transition-colors">Home</a>
            <span>/</span>
            <a href={`/${type}`} class="text-black">{dataType.name}</a>
            <span>/</span>
            <span class="text-black">{districtInfo.name}</span>
        </div>

        <div
            class="flex flex-col md:flex-row md:items-end justify-between gap-4"
        >
            <div>
                <h1 class="text-3xl font-bold text-black">{dataType.name}</h1>
                <p class="text-xl text-black">{districtInfo.name}</p>
            </div>
            <div class="text-sm text-black">
                Last Updated: {new Date().toLocaleString()}
            </div>
        </div>
    </div>

    <Explorer
        client:load
        type={type as DataTypeId}
        district={district as string}
        initialData={initialData}
    />
</Layout>
