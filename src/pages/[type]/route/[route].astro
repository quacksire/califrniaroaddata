---
import Layout from "../../../layouts/Layout.astro";
import Explorer from "../../../components/Explorer";
import {
    DATA_TYPES,
    getApiUrl,
    getLocationName,
    getHighway,
    getCounties,
    type DataTypeId,
    type AnyDataItem,
} from "../../../utils/caltrans";
import { ROUTES } from "../../../data/locations";

export function getStaticPaths() {
    const paths = [];
    for (const typeKey of Object.keys(DATA_TYPES)) {
        for (const route of ROUTES) {
            paths.push({
                params: { type: typeKey, route },
            });
        }
    }
    return paths;
}

const { type, route } = Astro.params;
const dataType = DATA_TYPES[type as DataTypeId];

if (!dataType) {
    return Astro.redirect("/404");
}

// Fetch data from ALL districts for this type
let aggregatedData: AnyDataItem[] = [];
const districts = dataType.districts;

// Parallel fetch for better build performance
const fetchPromises = districts.map(async (districtId) => {
    try {
        const url = getApiUrl(type as DataTypeId, districtId);
        const res = await fetch(url);
        if (res.ok) {
            const json = await res.json();
            if (json && Array.isArray(json.data)) {
                return json.data as AnyDataItem[];
            }
        }
    } catch (e) {
        console.error(`Failed to fetch data for ${type} ${districtId}`, e);
    }
    return [];
});

const results = await Promise.all(fetchPromises);
aggregatedData = results.flat();

// Filter by route
const filteredData = aggregatedData.filter((item) => {
    const name = getLocationName(item);
    const itemHighway = getHighway(name);
    return itemHighway === route;
});

// SEO Logic
const uniqueCounties = Array.from(
    new Set(filteredData.flatMap((item) => getCounties(item))),
).sort();

const countyListPhrase =
    uniqueCounties.length > 0
        ? `across ${uniqueCounties.join(", ")} counties`
        : "";

const isCamera = type === "cctv";
const typeKeywords = isCamera
    ? "live traffic cameras, highway surveillance, traffic cams"
    : `${dataType.name}, road conditions, highway status`;

const title = `Live ${dataType.name} on ${route} | California Road Data`;

const seoDescription = `current real-time ${dataType.name.toLowerCase()} updates for ${route} ${countyListPhrase}`;
---

<Layout title={title}>
    <div class="mb-8">
        <div class="flex items-center gap-2 text-sm text-black mb-4">
            <a href="/" class="text-black transition-colors">Home</a>
            <span>/</span>
            <a href={`/${type}`} class="text-black">{dataType.name}</a>
            <span>/</span>
            <span class="text-black">{route}</span>
        </div>

        <div
            class="flex flex-col md:flex-row md:items-end justify-between gap-4"
        >
            <div>
                <h1 class="text-3xl font-bold text-black">
                    {
                        isCamera
                            ? `Live Cameras: ${route}`
                            : `${dataType.name}: ${route}`
                    }
                </h1>
                <p class="text-xl text-black">
                    {
                        isCamera
                            ? `Real-time views from ${route}`
                            : `Current ${dataType.name} status for ${route}`
                    }
                </p>
            </div>
            <div class="text-sm text-black">
                Last Updated: {new Date().toLocaleString()}
            </div>
        </div>
    </div>

    <Explorer
        client:load
        type={type as DataTypeId}
        district="All"
        initialData={filteredData}
    />

    <div class="mt-12 prose prose-slate max-w-none">
        <h2 class="text-xl font-bold mb-3">
            About {dataType.name} on {route}
        </h2>
        <p>
            View {seoDescription}. Whether you are on a road trip or daily
            commute, stay informed with unbiased data directly from Caltrans
            instruments on {route}.
        </p>
        <p>
            This page filters data specifically for <strong>{route}</strong>{
                uniqueCounties.length > 0
                    ? `, passing through ${uniqueCounties.join(", ")}.`
                    : "."
            }
            Monitor {typeKeywords} to safely plan your journey.
        </p>
    </div>
</Layout>
