---
import Layout from "../../../layouts/Layout.astro";
import Explorer from "../../../components/Explorer";
import {
    DATA_TYPES,
    getApiUrl,
    getCounties,
    getHighwayFromItem,
    type DataTypeId,
    type AnyDataItem,
} from "../../../utils/caltrans";
import { COUNTIES } from "../../../data/locations";

export function getStaticPaths() {
    const paths = [];
    for (const typeKey of Object.keys(DATA_TYPES)) {
        for (const county of COUNTIES) {
            paths.push({
                params: { type: typeKey, county },
            });
        }
    }
    return paths;
}

const { type, county } = Astro.params;
const dataType = DATA_TYPES[type as DataTypeId];

if (!dataType) {
    return Astro.redirect("/404");
}

// Fetch data from ALL districts for this type
let aggregatedData: AnyDataItem[] = [];
const districts = dataType.districts;

const fetchPromises = districts.map(async (districtId) => {
    try {
        const url = getApiUrl(type as DataTypeId, districtId);
        const res = await fetch(url);
        if (res.ok) {
            const json = await res.json();
            if (json && Array.isArray(json.data)) {
                return json.data as AnyDataItem[];
            }
        }
    } catch (e) {
        console.error(`Failed to fetch data for ${type} ${districtId}`, e);
    }
    return [];
});

const results = await Promise.all(fetchPromises);
aggregatedData = results.flat();

// Filter by county
const filteredData = aggregatedData.filter((item) => {
    const itemCounties = getCounties(item);
    // Caltrans data might be uppercase or have different casing
    return itemCounties.some((c) => c.toLowerCase() === county.toLowerCase());
});

// SEO Logic
const uniqueRoutes = Array.from(
    new Set(
        filteredData.map((item) => getHighwayFromItem(item)).filter(Boolean),
    ),
).sort((a, b) => {
    // Natural sort for routes (e.g. 101, 280) if possible, or simple alphabetical
    return (a || "").localeCompare(b || "", undefined, { numeric: true });
});

const routeListPhrase =
    uniqueRoutes.length > 0
        ? `including ${uniqueRoutes.slice(0, 15).join(", ")}${uniqueRoutes.length > 15 ? " and more" : ""}`
        : "across the region";

const isCamera = type === "cctv";
const typeKeywords = isCamera
    ? "live traffic cameras, Caltrans CCTV, freeway webcams"
    : `${dataType.name}, road conditions, highway status`;

const title = `Live ${dataType.name} in ${county} County | California Road Data`;

const seoDescription = `current real-time ${dataType.name.toLowerCase()} updates for all highways in ${county} County, ${routeListPhrase}`;
---

<Layout title={title}>
    <div class="mb-8">
        <div class="flex items-center gap-2 text-sm text-black mb-4">
            <a href="/" class="text-black transition-colors">Home</a>
            <span>/</span>
            <a href={`/${type}`} class="text-black">{dataType.name}</a>
            <span>/</span>
            <span class="text-black">{county} County</span>
        </div>

        <div
            class="flex flex-col md:flex-row md:items-end justify-between gap-4"
        >
            <div>
                <h1 class="text-3xl font-bold text-black">
                    {
                        isCamera
                            ? `Live Cameras: ${county} County`
                            : `${dataType.name}: ${county} County`
                    }
                </h1>
                <p class="text-xl text-black">
                    {
                        isCamera
                            ? `Real-time views from ${county} County highways`
                            : `Current ${dataType.name} status for ${county} County`
                    }
                </p>
            </div>
            <div class="text-sm text-black">
                Last Updated: {new Date().toLocaleString()}
            </div>
        </div>
    </div>

    <Explorer
        client:load
        type={type as DataTypeId}
        district="All"
        initialData={filteredData}
    />

    <div class="mt-12 prose prose-slate max-w-none">
        <h2 class="text-xl font-bold mb-3">
            About {dataType.name} in {county} County
        </h2>
        <p>
            View {seoDescription}. Whether you are commuting through {county} County
            or traveling long-distance, these {typeKeywords} provide vital information
            for a safe trip.
        </p>
        <p>
            Data is sourced directly from Caltrans and includes coverage of
            major routes and local highways within the county,
            {
                uniqueRoutes.length > 0
                    ? `specifically monitoring ${uniqueRoutes.join(", ")}.`
                    : "covering key transit arteries."
            }
            Check back for latest updates on congestion, weather impacts, and road
            work.
        </p>
    </div>
</Layout>
